<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大阪馬拉松 - 寶可夢冒險</title>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs (Compatibility Mode for better stability) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #FFFDF5;
            color: #5D4037;
            margin: 0;
            background-image: radial-gradient(#FFB7C5 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        .kawaii-shadow { box-shadow: 0 8px 0px rgba(235, 169, 185, 0.2); }
        
        /* 寶可夢動畫 */
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes rotate-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes sway { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        
        .animate-poke-bounce { animation: bounce 2s infinite ease-in-out; }
        .animate-poke-sway { animation: sway 3s infinite ease-in-out; }
        .animate-poke-spin { animation: rotate-slow 12s infinite linear; }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 2px solid white;
            border-radius: 2rem;
        }

        .peach-gradient {
            background: linear-gradient(135deg, #C85994 0%, #E98AB1 100%);
        }

        /* 滾動條隱藏 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Firebase Config ---
        const firebaseConfig = JSON.parse(__firebase_config);
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pokemon-osaka-run';

        // --- 迷你寶可夢 SVG 組件 ---
        const Pikachu = ({ className }) => (
            <svg viewBox="0 0 100 100" className={`${className} animate-poke-sway`}>
                <circle cx="50" cy="60" r="35" fill="#FBD743" />
                <path d="M20 20 L35 50 L15 60 Z" fill="#FBD743" stroke="#333" strokeWidth="2"/>
                <path d="M80 20 L65 50 L85 60 Z" fill="#FBD743" stroke="#333" strokeWidth="2"/>
                <circle cx="35" cy="55" r="4" fill="#333" />
                <circle cx="65" cy="55" r="4" fill="#333" />
                <circle cx="28" cy="70" r="6" fill="#FF5252" />
                <circle cx="72" cy="70" r="6" fill="#FF5252" />
            </svg>
        );

        const Pokeball = ({ className }) => (
            <svg viewBox="0 0 100 100" className={`${className} animate-poke-spin`}>
                <circle cx="50" cy="50" r="45" fill="white" stroke="#333" strokeWidth="4" />
                <path d="M5 50 A45 45 0 0 1 95 50 Z" fill="#FF5252" stroke="#333" strokeWidth="4" />
                <rect x="5" y="46" width="90" height="8" fill="#333" />
                <circle cx="50" cy="50" r="12" fill="white" stroke="#333" strokeWidth="4" />
            </svg>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('home');
            const [expenses, setExpenses] = useState([]);
            const [currentTime, setCurrentTime] = useState(new Date());

            // Auth & Init
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                };
                initAuth();
                const unsub = auth.onAuthStateChanged(u => setUser(u));
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => { unsub(); clearInterval(timer); };
            }, []);

            // Data Fetch
            useEffect(() => {
                if (!user) return;
                const unsub = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('expenses')
                    .onSnapshot(s => {
                        const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
                        setExpenses(data);
                    });
                return () => unsub();
            }, [user]);

            // Icons
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [activeTab, expenses]);

            const osakaTime = new Date(currentTime.toLocaleString("en-US", {timeZone: "Asia/Tokyo"}));

            // 圓餅圖數據
            const budgetData = useMemo(() => {
                const summary = { '吃': 0, '買': 0, '交通': 0, '其他': 0 };
                let total = 0;
                expenses.forEach(e => {
                    const val = parseFloat(e.amount) || 0;
                    summary[e.category] = (summary[e.category] || 0) + val;
                    total += val;
                });
                return { summary, total };
            }, [expenses]);

            // 簡易 SVG 圓餅圖
            const renderPie = () => {
                const { summary, total } = budgetData;
                if (total === 0) return <div className="w-24 h-24 rounded-full bg-slate-100 flex items-center justify-center text-[10px]">無數據</div>;
                
                let angleSum = 0;
                const colors = { '吃': '#FBD743', '買': '#FFB7C5', '交通': '#A0D8EF', '其他': '#E0E0E0' };
                
                return (
                    <svg viewBox="0 0 100 100" className="w-24 h-24 transform -rotate-90">
                        {Object.entries(summary).map(([cat, val]) => {
                            if (val === 0) return null;
                            const angle = (val / total) * 360;
                            const x1 = 50 + 40 * Math.cos(Math.PI * angleSum / 180);
                            const y1 = 50 + 40 * Math.sin(Math.PI * angleSum / 180);
                            angleSum += angle;
                            const x2 = 50 + 40 * Math.cos(Math.PI * angleSum / 180);
                            const y2 = 50 + 40 * Math.sin(Math.PI * angleSum / 180);
                            return (
                                <path 
                                    key={cat}
                                    d={`M 50 50 L ${x1} ${y1} A 40 40 0 ${angle > 180 ? 1 : 0} 1 ${x2} ${y2} Z`} 
                                    fill={colors[cat]} 
                                    stroke="white" 
                                    strokeWidth="2"
                                />
                            );
                        })}
                        <circle cx="50" cy="50" r="20" fill="white" />
                    </svg>
                );
            };

            return (
                <div className="max-w-md mx-auto min-h-screen relative pb-28">
                    {/* Header */}
                    <header className="bg-[#FFB7C5] p-6 pt-12 rounded-b-[3rem] shadow-lg relative overflow-hidden">
                        <Pikachu className="absolute right-4 top-10 w-16 h-16" />
                        <div className="relative z-10 text-white">
                            <h1 className="text-3xl font-black">大阪馬拉松</h1>
                            <div className="flex items-center gap-2 mt-1">
                                <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                <span className="text-[10px] font-bold tracking-widest opacity-90">已連接雲端中心</span>
                            </div>
                        </div>
                    </header>

                    <main className="p-5 space-y-6">
                        
                        {/* 首頁 */}
                        {activeTab === 'home' && (
                            <div className="space-y-6 animate-in fade-in">
                                {/* 實時資訊 */}
                                <div className="glass-card p-6 shadow-sm flex justify-between items-center relative">
                                    <Pokeball className="absolute -right-4 -bottom-4 w-20 h-20 opacity-10" />
                                    <div>
                                        <p className="text-[10px] font-black text-[#FFB7C5] tracking-widest uppercase">Osaka Time</p>
                                        <h2 className="text-5xl font-black text-[#5D4037]">
                                            {osakaTime.toLocaleTimeString('zh-HK', { hour12: false, hour: '2-digit', minute: '2-digit' })}
                                        </h2>
                                        <p className="text-xs mt-1 opacity-60 font-bold">現時氣溫 11°C · 晴</p>
                                    </div>
                                </div>

                                {/* Peach 航班 */}
                                <div className="peach-gradient p-5 rounded-[2.5rem] text-white shadow-lg relative overflow-hidden">
                                    <div className="flex justify-between items-center mb-4">
                                        <span className="text-xs font-black bg-white/20 px-3 py-1 rounded-full uppercase">Peach MM0060 / MM0067</span>
                                        <i data-lucide="plane" className="w-5 h-5"></i>
                                    </div>
                                    <div className="flex justify-between items-center px-4">
                                        <div className="text-center">
                                            <p className="text-xl font-black">HKG</p>
                                            <p className="text-[10px] opacity-70">香港</p>
                                        </div>
                                        <div className="flex-1 flex flex-col items-center px-4">
                                            <div className="w-full h-[2px] bg-white/30 relative">
                                                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-1 rounded-full">
                                                    <i data-lucide="heart" className="w-2 h-2 text-[#C85994]"></i>
                                                </div>
                                            </div>
                                            <p className="text-[10px] mt-1 font-bold">2/20 出發</p>
                                        </div>
                                        <div className="text-center">
                                            <p className="text-xl font-black">KIX</p>
                                            <p className="text-[10px] opacity-70">大阪</p>
                                        </div>
                                    </div>
                                </div>

                                {/* 匯率與倒數 */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white p-5 rounded-[2rem] border-2 border-[#FBD743]/20 text-center">
                                        <p className="text-[10px] font-bold text-slate-400">匯率參考</p>
                                        <p className="text-lg font-black mt-1">1 JPY</p>
                                        <p className="text-2xl font-black text-[#FBD743]">0.052 HKD</p>
                                    </div>
                                    <div className="bg-white p-5 rounded-[2rem] border-2 border-[#FFB7C5]/20 text-center">
                                        <p className="text-[10px] font-bold text-slate-400">距離起跑</p>
                                        <p className="text-4xl font-black text-[#FFB7C5] mt-1">7</p>
                                        <p className="text-[10px] font-bold">DAYS</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 地圖 */}
                        {activeTab === 'map' && (
                            <div className="space-y-4 animate-in fade-in h-[60vh]">
                                <div className="w-full h-full rounded-[3rem] border-4 border-[#FBD743] overflow-hidden shadow-2xl bg-white">
                                    <iframe 
                                        width="100%" 
                                        height="100%" 
                                        frameBorder="0" 
                                        src={`https://maps.google.com/maps?q=34.6937,135.5023&t=&z=14&ie=UTF8&iwloc=&output=embed`}
                                    ></iframe>
                                </div>
                                <button 
                                    onClick={() => window.location.href="https://www.google.com/maps/search/?api=1&query=大阪城"}
                                    className="w-full py-4 bg-[#5D4037] text-white font-black rounded-full flex justify-center items-center gap-2"
                                >
                                    <i data-lucide="map"></i> 開啟 Google Maps App
                                </button>
                            </div>
                        )}

                        {/* 記帳 */}
                        {activeTab === 'budget' && (
                            <div className="space-y-4 animate-in fade-in">
                                <div className="glass-card p-6 flex items-center justify-between shadow-sm">
                                    <div>
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">總支出</p>
                                        <h2 className="text-3xl font-black text-[#C85994]">¥{budgetData.total.toLocaleString()}</h2>
                                        <p className="text-xs font-bold opacity-50 mt-1">約 HKD {(budgetData.total * 0.052).toFixed(1)}</p>
                                    </div>
                                    <div className="relative">
                                        {renderPie()}
                                    </div>
                                </div>

                                <div className="bg-white p-6 rounded-[2.5rem] border-2 border-[#FBD743]/20 space-y-4">
                                    <div className="flex gap-2">
                                        <input type="number" id="amt" placeholder="¥金額" className="flex-1 p-4 bg-[#FFFDF5] rounded-2xl font-black border-none outline-none focus:ring-2 ring-[#FBD743]" />
                                        <select id="cat" className="p-4 bg-[#FFFDF5] rounded-2xl font-black border-none outline-none">
                                            {['吃', '買', '交通', '其他'].map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                    <input type="text" id="note" placeholder="項目備註..." className="w-full p-4 bg-[#FFFDF5] rounded-2xl font-black border-none outline-none" />
                                    <button 
                                        onClick={async () => {
                                            const a = document.getElementById('amt').value;
                                            const c = document.getElementById('cat').value;
                                            const n = document.getElementById('note').value;
                                            if (!a || !user) return;
                                            await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('expenses').add({
                                                amount: parseFloat(a), category: c, note: n, date: new Date().toISOString()
                                            });
                                            document.getElementById('amt').value = '';
                                            document.getElementById('note').value = '';
                                        }}
                                        className="w-full py-4 bg-[#FBD743] text-[#5D4037] font-black rounded-full shadow-lg active:scale-95 transition-all"
                                    >
                                        捕捉這筆開支！
                                    </button>
                                </div>

                                <div className="space-y-2">
                                    {expenses.map(e => (
                                        <div key={e.id} className="bg-white p-4 rounded-2xl flex justify-between items-center border border-slate-50">
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-full bg-[#FFB7C5]/20 flex items-center justify-center text-[10px] font-black text-[#C85994]">{e.category}</div>
                                                <div>
                                                    <p className="font-bold text-sm">{e.note || e.category}</p>
                                                    <p className="text-[10px] opacity-40">¥{e.amount}</p>
                                                </div>
                                            </div>
                                            <button onClick={() => db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('expenses').doc(e.id).delete()} className="text-slate-200 hover:text-red-400">
                                                <i data-lucide="x-circle" className="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Bottom Nav */}
                    <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-sm bg-white/90 backdrop-blur-md p-2 rounded-full shadow-2xl flex justify-around items-center border border-white/50 z-50">
                        {[
                            { id: 'home', icon: 'home' },
                            { id: 'map', icon: 'map-pin' },
                            { id: 'budget', icon: 'pocket' }
                        ].map(t => (
                            <button 
                                key={t.id} 
                                onClick={() => setActiveTab(t.id)}
                                className={`p-4 rounded-full transition-all duration-300 ${activeTab === t.id ? 'bg-[#FFB7C5] text-white -translate-y-4 shadow-xl' : 'text-[#5D4037]/30'}`}
                            >
                                <i data-lucide={t.icon} className="w-6 h-6"></i>
                            </button>
                        ))}
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
