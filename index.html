<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大阪馬拉松之旅 - Pokémon Edition</title>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <style>
        /* 引入圓潤可愛字體 */
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
        
        :root {
            --pikachu-yellow: #FBD743;
            --jiggly-pink: #FFB7C5;
            --snorlax-blue: #3E4C5E;
            --cream-bg: #FFFDF5;
            --text-brown: #5D4037;
            --peach-purple: #C85994; /* 樂桃航空色 */
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--cream-bg);
            color: var(--text-brown);
            margin: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            background-image: radial-gradient(#FFB7C5 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .rounded-super { border-radius: 2rem; }
        
        /* 動畫定義 */
        @keyframes bounce-soft { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes waddle { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
        @keyframes sleep { 0%, 50% { transform: scale(1); } 25% { transform: scale(1.05); } }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes float-sakura { 0% { transform: translateY(0) rotate(0deg); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(20px) rotate(180deg); opacity: 0; } }

        .animate-bounce-soft { animation: bounce-soft 3s infinite ease-in-out; }
        .animate-waddle { animation: waddle 2s infinite ease-in-out; }
        .animate-sleep { animation: sleep 4s infinite ease-in-out; }
        .animate-spin-slow { animation: spin-slow 10s infinite linear; }
        
        /* 櫻花飄落 */
        .sakura {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #FFB7C5;
            border-radius: 10px 0 10px 0;
            animation: float-sakura 4s infinite linear;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            border: 2px solid white;
            box-shadow: 0 4px 15px rgba(235, 169, 185, 0.2);
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- Firebase 初始化 ---
        const firebaseConfig = JSON.parse(__firebase_config);
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'osaka-marathon-poke';

        // --- 迷你寶可夢組件 (SVG) ---

        const Pikachu = ({ className = "w-12 h-12" }) => (
            <svg viewBox="0 0 100 100" className={`${className} animate-waddle`}>
                <path d="M20 20 L30 50 L15 60 Z" fill="#FBD743" stroke="#5D4037" strokeWidth="3" />
                <path d="M80 20 L70 50 L85 60 Z" fill="#FBD743" stroke="#5D4037" strokeWidth="3" />
                <circle cx="50" cy="60" r="35" fill="#FBD743" stroke="#5D4037" strokeWidth="3" />
                <circle cx="35" cy="55" r="4" fill="#333" />
                <circle cx="65" cy="55" r="4" fill="#333" />
                <circle cx="37" cy="53" r="1.5" fill="white" />
                <circle cx="67" cy="53" r="1.5" fill="white" />
                <circle cx="28" cy="68" r="6" fill="#FF5252" opacity="0.8" />
                <circle cx="72" cy="68" r="6" fill="#FF5252" opacity="0.8" />
                <path d="M45 70 Q50 75 55 70" fill="none" stroke="#5D4037" strokeWidth="3" />
            </svg>
        );

        const Jigglypuff = ({ className = "w-10 h-10" }) => (
            <svg viewBox="0 0 100 100" className={`${className} animate-bounce-soft`}>
                <circle cx="50" cy="50" r="40" fill="#FFB7C5" stroke="#5D4037" strokeWidth="3" />
                <path d="M30 20 L40 40 L20 40 Z" fill="#FFB7C5" stroke="#5D4037" strokeWidth="3" />
                <path d="M70 20 L60 40 L80 40 Z" fill="#FFB7C5" stroke="#5D4037" strokeWidth="3" />
                <circle cx="35" cy="50" r="8" fill="white" stroke="#5D4037" strokeWidth="2" />
                <circle cx="65" cy="50" r="8" fill="white" stroke="#5D4037" strokeWidth="2" />
                <circle cx="35" cy="50" r="4" fill="#369" />
                <circle cx="65" cy="50" r="4" fill="#369" />
                <path d="M45 25 Q50 40 55 25" fill="none" stroke="#5D4037" strokeWidth="3" />
                <path d="M48 65 Q50 62 52 65" fill="none" stroke="#5D4037" strokeWidth="2" />
            </svg>
        );

        const Snorlax = ({ className = "w-14 h-14" }) => (
            <svg viewBox="0 0 100 100" className={`${className} animate-sleep`}>
                <path d="M20 40 Q50 10 80 40 L80 90 Q50 100 20 90 Z" fill="#3E4C5E" stroke="#5D4037" strokeWidth="3" />
                <path d="M30 45 Q50 25 70 45 Q75 60 70 80 Q50 90 30 80 Q25 60 30 45" fill="#F5F5DC" stroke="#5D4037" strokeWidth="3" />
                <path d="M35 55 L45 55" stroke="#333" strokeWidth="3" />
                <path d="M55 55 L65 55" stroke="#333" strokeWidth="3" />
                <path d="M45 65 L55 65" stroke="#333" strokeWidth="2" />
            </svg>
        );

        const Eevee = ({ className = "w-10 h-10" }) => (
            <svg viewBox="0 0 100 100" className={`${className} animate-waddle`}>
                <ellipse cx="50" cy="50" rx="35" ry="30" fill="#A0522D" stroke="#5D4037" strokeWidth="3" />
                <path d="M15 30 L30 50 L20 60 Z" fill="#A0522D" stroke="#5D4037" strokeWidth="3" />
                <path d="M85 30 L70 50 L80 60 Z" fill="#A0522D" stroke="#5D4037" strokeWidth="3" />
                <circle cx="35" cy="50" r="4" fill="#333" />
                <circle cx="65" cy="50" r="4" fill="#333" />
                <path d="M45 60 Q50 63 55 60" fill="none" stroke="#5D4037" strokeWidth="2" />
                <path d="M35 80 Q50 90 65 80" fill="#F5DEB3" stroke="#5D4037" strokeWidth="3" />
            </svg>
        );

        const Pokeball = ({ className = "w-6 h-6", rotate = false }) => (
            <svg viewBox="0 0 100 100" className={`${className} ${rotate ? 'animate-spin-slow' : ''}`}>
                <circle cx="50" cy="50" r="45" fill="white" stroke="#5D4037" strokeWidth="5" />
                <path d="M5 50 A45 45 0 0 1 95 50" fill="#FF5252" />
                <rect x="5" y="45" width="90" height="10" fill="#5D4037" />
                <circle cx="50" cy="50" r="15" fill="white" stroke="#5D4037" strokeWidth="5" />
                <circle cx="50" cy="50" r="6" fill="#5D4037" opacity="0.2" />
            </svg>
        );

        // --- 主應用 ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('home');
            const [openDay, setOpenDay] = useState(0);
            const [expenses, setExpenses] = useState([]);
            const [currentTime, setCurrentTime] = useState(new Date());

            // 初始化
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) { console.error(e); }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged(u => setUser(u));
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => { unsubscribe(); clearInterval(timer); };
            }, []);

            // 數據同步
            useEffect(() => {
                if (!user) return;
                const unsub = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('expenses')
                    .onSnapshot(s => {
                        const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
                        setExpenses(data.sort((a,b) => new Date(b.date) - new Date(a.date)));
                    });
                return () => unsub();
            }, [user]);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [activeTab, openDay, expenses, user]);

            const osakaTime = new Date(currentTime.toLocaleString("en-US", {timeZone: "Asia/Tokyo"}));

            const itineraryData = [
                { day: 1, date: '2/20 (五)', location: '大阪市中心', lat: 34.6937, lng: 135.5023, events: [{ title: '黑門市場', desc: '尋找鯉魚王生魚片' }, { title: 'Hotel Mystays Otemae', desc: '寶可夢中心休整' }] },
                { day: 2, date: '2/21 (六)', location: 'INTEX大阪', lat: 34.6369, lng: 135.4211, events: [{ title: 'Diorama Restaurant', desc: '喵喵怪餐廳' }, { title: '領取號碼布', desc: 'EXPO 冒險' }] },
                { day: 3, date: '2/22 (日)', location: '大阪城公園', lat: 34.6873, lng: 135.5262, events: [{ title: '全馬起跑', desc: '燃燒吧！小火龍之魂' }, { title: 'Spa World', desc: '傑尼龜水炮溫泉' }] },
                { day: 4, date: '2/23 (一)', location: '和歌山', lat: 34.2260, lng: 135.1675, events: [{ title: '黑潮市場', desc: '吼鯨王解體秀' }, { title: '貴志站', desc: '拜訪貓老大站長' }] },
                { day: 5, date: '2/24 (二)', location: '關西機場', lat: 34.4320, lng: 135.2304, events: [{ title: '崎之湯', desc: '海邊露天風呂' }, { title: 'Rinku Outlet', desc: '最後的捕捉機會' }] }
            ];

            const currentDayData = itineraryData[openDay] || itineraryData[0];

            // 圓餅圖數據計算
            const categoryData = useMemo(() => {
                const cats = { '吃': 0, '買': 0, '交通': 0, '其他': 0 };
                let total = 0;
                expenses.forEach(e => {
                    const amt = parseFloat(e.amount) || 0;
                    cats[e.category] = (cats[e.category] || 0) + amt;
                    total += amt;
                });
                return { cats, total };
            }, [expenses]);

            // 繪製 SVG 圓餅圖
            const renderPieChart = () => {
                const { cats, total } = categoryData;
                if (total === 0) return (
                    <div className="w-32 h-32 rounded-full border-4 border-dashed border-[#FFB7C5] flex items-center justify-center text-xs text-[#5D4037] bg-white">
                        無數據
                    </div>
                );
                
                let currentAngle = 0;
                const colors = { '吃': '#FBD743', '買': '#FFB7C5', '交通': '#A0D8EF', '其他': '#C3C3C3' };
                
                return (
                    <svg viewBox="0 0 100 100" className="w-32 h-32 drop-shadow-md transform -rotate-90">
                        {Object.entries(cats).map(([label, value]) => {
                            if (value === 0) return null;
                            const sliceAngle = (value / total) * 360;
                            const x1 = 50 + 40 * Math.cos(Math.PI * currentAngle / 180);
                            const y1 = 50 + 40 * Math.sin(Math.PI * currentAngle / 180);
                            const x2 = 50 + 40 * Math.cos(Math.PI * (currentAngle + sliceAngle) / 180);
                            const y2 = 50 + 40 * Math.sin(Math.PI * (currentAngle + sliceAngle) / 180);
                            const largeArc = sliceAngle > 180 ? 1 : 0;
                            
                            const pathData = `M 50 50 L ${x1} ${y1} A 40 40 0 ${largeArc} 1 ${x2} ${y2} Z`;
                            currentAngle += sliceAngle;
                            
                            return <path key={label} d={pathData} fill={colors[label]} stroke="white" strokeWidth="2" />;
                        })}
                        <circle cx="50" cy="50" r="18" fill="white" />
                        <image href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='10' fill='%235D4037'/></svg>" x="40" y="40" width="20" height="20" />
                    </svg>
                );
            };

            return (
                <div className="min-h-screen pb-32">
                    {/* Header */}
                    <header className="bg-[#FFB7C5] p-6 pt-12 rounded-b-[40px] shadow-lg relative overflow-hidden">
                        <Pikachu className="absolute right-4 top-10 w-16 h-16 z-10" />
                        <Jigglypuff className="absolute left-6 bottom-4 w-10 h-10 opacity-90 z-10" />
                        <Pokeball className="absolute -top-10 -left-10 w-40 h-40 opacity-10" rotate={true} />
                        
                        <div className="relative z-10 text-[#5D4037]">
                            <div className="flex items-center gap-2 mb-1">
                                <span className="bg-white/50 px-2 py-0.5 rounded-full text-[10px] font-bold">2026.02.20 - 02.24</span>
                                <Pokeball className="w-4 h-4" />
                            </div>
                            <h1 className="text-3xl font-black tracking-tight">大阪マラソン</h1>
                            <p className="text-xs font-bold opacity-80 mt-1">
                                {user ? '● 已連接寶可夢雲端' : '● 離線模式'}
                            </p>
                        </div>
                        {/* 飄落櫻花 */}
                        <div className="sakura" style={{top: '10%', left: '20%', animationDelay: '0s'}}></div>
                        <div className="sakura" style={{top: '20%', left: '80%', animationDelay: '1s'}}></div>
                        <div className="sakura" style={{top: '50%', left: '50%', animationDelay: '2s'}}></div>
                    </header>

                    <main className="p-5 space-y-6">
                        
                        {/* --- 首頁 --- */}
                        {activeTab === 'home' && (
                            <div className="space-y-6 animate-in fade-in duration-500">
                                {/* 大阪時間卡 */}
                                <div className="glass-panel p-6 rounded-super flex justify-between items-center relative overflow-hidden">
                                    <Snorlax className="absolute -right-2 -bottom-2 opacity-80" />
                                    <div>
                                        <div className="flex items-center gap-1 mb-1">
                                            <i data-lucide="map-pin" className="w-3 h-3 text-[#FFB7C5]"></i>
                                            <span className="text-[10px] font-black text-[#5D4037]">OSAKA, JAPAN</span>
                                        </div>
                                        <h2 className="text-5xl font-black text-[#5D4037]">
                                            {osakaTime.toLocaleTimeString('zh-HK', { hour12: false, hour: '2-digit', minute: '2-digit' })}
                                        </h2>
                                        <p className="text-xs font-bold text-[#5D4037]/60">現時氣溫 11°C</p>
                                    </div>
                                </div>

                                {/* Peach 航班卡 */}
                                <div className="bg-[#C85994] text-white p-5 rounded-super relative shadow-lg overflow-hidden">
                                    <div className="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-10 -mt-10"></div>
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="font-black text-sm flex items-center gap-2">
                                            <i data-lucide="plane" className="w-4 h-4"></i> Peach Aviation
                                        </h3>
                                        <Eevee className="w-8 h-8 absolute top-2 right-2" />
                                    </div>
                                    
                                    {/* 去程 */}
                                    <div className="flex justify-between items-center mb-4 border-b border-white/20 pb-2">
                                        <div className="text-center">
                                            <p className="text-xl font-black">HKG</p>
                                        </div>
                                        <div className="flex flex-col items-center px-2">
                                            <p className="text-[10px] font-bold opacity-80">MM0060</p>
                                            <div className="w-16 h-[2px] bg-white/50 my-1 relative">
                                                <div className="absolute right-0 top-1/2 -translate-y-1/2 w-1 h-1 bg-white rounded-full"></div>
                                            </div>
                                            <p className="text-[10px]">去程</p>
                                        </div>
                                        <div className="text-center">
                                            <p className="text-xl font-black">KIX</p>
                                        </div>
                                    </div>

                                    {/* 回程 */}
                                    <div className="flex justify-between items-center">
                                        <div className="text-center">
                                            <p className="text-xl font-black">KIX</p>
                                        </div>
                                        <div className="flex flex-col items-center px-2">
                                            <p className="text-[10px] font-bold opacity-80">MM0067</p>
                                            <div className="w-16 h-[2px] bg-white/50 my-1 relative">
                                                <div className="absolute left-0 top-1/2 -translate-y-1/2 w-1 h-1 bg-white rounded-full"></div>
                                            </div>
                                            <p className="text-[10px]">回程</p>
                                        </div>
                                        <div className="text-center">
                                            <p className="text-xl font-black">HKG</p>
                                        </div>
                                    </div>
                                </div>

                                {/* 匯率與倒數 */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white p-4 rounded-3xl shadow-sm flex flex-col items-center justify-center text-center border-2 border-[#FBD743]/20">
                                        <p className="text-[10px] font-bold text-[#5D4037] mb-1">匯率參考</p>
                                        <p className="text-xl font-black text-[#5D4037]">1 JPY</p>
                                        <i data-lucide="arrow-down" className="w-3 h-3 text-[#5D4037]/50 my-1"></i>
                                        <p className="text-xl font-black text-[#FBD743]">$0.052</p>
                                        <p className="text-[8px] text-[#5D4037]/40 mt-1">HKD</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-3xl shadow-sm flex flex-col items-center justify-center text-center border-2 border-[#FFB7C5]/20">
                                        <p className="text-[10px] font-bold text-[#5D4037] mb-1">冒險倒數</p>
                                        <div className="relative">
                                            <Pokeball className="w-12 h-12 opacity-10 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" />
                                            <p className="text-3xl font-black text-[#FFB7C5]">7</p>
                                        </div>
                                        <p className="text-[10px] text-[#5D4037]/60">Days Left</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- 行程 --- */}
                        {activeTab === 'itinerary' && (
                            <div className="space-y-4 animate-in slide-in-from-bottom-5">
                                {itineraryData.map((d, i) => (
                                    <div key={i} className="bg-white rounded-[30px] border border-[#FFB7C5]/30 shadow-sm overflow-hidden transition-all">
                                        <button onClick={() => setOpenDay(i)} className={`w-full p-5 flex justify-between items-center ${openDay === i ? 'bg-[#FFB7C5]/10' : ''}`}>
                                            <div className="text-left flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-black text-sm ${openDay === i ? 'bg-[#FBD743] text-[#5D4037]' : 'bg-[#F0F0F0] text-[#AAA]'}`}>
                                                    D{d.day}
                                                </div>
                                                <div>
                                                    <h4 className="font-black text-[#5D4037]">{d.location}</h4>
                                                    <span className="text-[10px] font-bold text-[#C85994]">{d.date}</span>
                                                </div>
                                            </div>
                                            <i data-lucide="chevron-down" className={`transition-transform text-[#5D4037] ${openDay === i ? 'rotate-180' : ''}`}></i>
                                        </button>
                                        {openDay === i && (
                                            <div className="p-5 pt-0 space-y-4">
                                                <div className="h-[1px] bg-dashed bg-[#FFB7C5]/50 w-full mb-4"></div>
                                                {d.events.map((e, idx) => (
                                                    <div key={idx} className="flex gap-4 items-start">
                                                        <Pokeball className="w-5 h-5 shrink-0 mt-1 opacity-60" />
                                                        <div>
                                                            <p className="font-black text-sm text-[#5D4037]">{e.title}</p>
                                                            <p className="text-xs text-[#5D4037]/60">{e.desc}</p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* --- 地圖 --- */}
                        {activeTab === 'map' && (
                            <div className="space-y-4 h-full flex flex-col">
                                <div className="flex gap-2 overflow-x-auto scrollbar-hide pb-2">
                                    {itineraryData.map((d, i) => (
                                        <button key={i} onClick={() => setOpenDay(i)} className={`px-4 py-2 rounded-full text-xs font-black shrink-0 transition-all ${openDay === i ? 'bg-[#FBD743] text-[#5D4037] shadow-md transform -translate-y-1' : 'bg-white text-[#5D4037]'}`}>
                                            Day {d.day}
                                        </button>
                                    ))}
                                </div>
                                
                                <div className="flex-1 min-h-[450px] rounded-[40px] border-4 border-[#FBD743] overflow-hidden shadow-xl relative bg-[#E0F7FA]">
                                    <iframe 
                                        width="100%" 
                                        height="100%" 
                                        frameBorder="0" 
                                        className="opacity-90"
                                        src={`https://maps.google.com/maps?q=${currentDayData.lat},${currentDayData.lng}&t=&z=14&ie=UTF8&iwloc=&output=embed`}
                                    ></iframe>
                                    <Pikachu className="absolute bottom-2 left-2 w-12 h-12 drop-shadow-lg" />
                                    <div className="absolute top-4 right-4 bg-white/90 p-2 px-4 rounded-full shadow-lg text-[10px] font-bold text-[#5D4037]">
                                        拖曳地圖尋找寶可夢！
                                    </div>
                                </div>

                                <div className="bg-white p-5 rounded-[30px] shadow-sm">
                                    <h4 className="text-xs font-black text-[#5D4037] mb-3 flex items-center gap-2">
                                        <i data-lucide="compass" className="w-4 h-4 text-[#C85994]"></i> 景點導航
                                    </h4>
                                    <div className="space-y-2">
                                        {currentDayData.events.map((e, i) => (
                                            <button 
                                                key={i} 
                                                onClick={() => window.location.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.title)}`}
                                                className="w-full flex justify-between items-center p-3 bg-[#FFFDF5] border border-[#FFB7C5]/30 rounded-2xl"
                                            >
                                                <span className="text-sm font-bold text-[#5D4037]">{e.title}</span>
                                                <i data-lucide="external-link" className="w-4 h-4 text-[#C85994]"></i>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- 記帳 --- */}
                        {activeTab === 'budget' && (
                            <div className="space-y-4 animate-in fade-in">
                                <div className="glass-panel p-6 rounded-[40px] flex items-center justify-between relative overflow-hidden">
                                    <div className="relative z-10">
                                        <p className="text-[10px] font-black text-[#5D4037]/60 mb-1">TOTAL EXPENSE</p>
                                        <h2 className="text-3xl font-black text-[#C85994]">
                                            ¥{categoryData.total.toLocaleString()}
                                        </h2>
                                    </div>
                                    <div className="relative z-10">
                                        {renderPieChart()}
                                    </div>
                                    <Jigglypuff className="absolute -bottom-2 -left-2 w-16 h-16 opacity-20" />
                                </div>

                                <div className="bg-white p-5 rounded-[30px] shadow-sm border border-[#FBD743]/30">
                                    <div className="grid grid-cols-2 gap-3 mb-3">
                                        <input type="number" id="amt" placeholder="¥ 金額" className="p-3 rounded-2xl bg-[#FFFDF5] border border-[#FBD743]/50 font-black outline-none text-[#5D4037]" />
                                        <select id="cat" className="p-3 rounded-2xl bg-[#FFFDF5] border border-[#FBD743]/50 font-black text-[#5D4037]">
                                            {['吃', '買', '交通', '其他'].map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                    <input type="text" id="note" placeholder="買了什麼？(如: 寶可夢娃娃)" className="w-full p-3 rounded-2xl bg-[#FFFDF5] border border-[#FBD743]/50 font-black mb-4 outline-none text-[#5D4037]" />
                                    <button 
                                        onClick={async () => {
                                            const a = document.getElementById('amt').value;
                                            const c = document.getElementById('cat').value;
                                            const n = document.getElementById('note').value;
                                            if (!a || !user) return;
                                            await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('expenses').add({
                                                amount: parseFloat(a), category: c, note: n, date: new Date().toISOString().split('T')[0]
                                            });
                                            document.getElementById('amt').value = '';
                                            document.getElementById('note').value = '';
                                        }}
                                        className="w-full py-3 bg-[#FBD743] text-[#5D4037] font-black rounded-2xl shadow-md active:scale-95 transition-all flex justify-center items-center gap-2"
                                    >
                                        <Pokeball className="w-4 h-4" /> 記錄開支
                                    </button>
                                </div>

                                <div className="space-y-2">
                                    {expenses.map(e => (
                                        <div key={e.id} className="bg-white p-3 px-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100">
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 rounded-full bg-[#FFB7C5]/30 flex items-center justify-center text-xs font-black text-[#C85994]">{e.category}</div>
                                                <div><p className="font-bold text-sm text-[#5D4037]">{e.note || e.category}</p><p className="text-[10px] text-[#5D4037]/50">¥{e.amount}</p></div>
                                            </div>
                                            <button onClick={() => db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('expenses').doc(e.id).delete()} className="text-[#5D4037]/30 hover:text-red-400">
                                                <i data-lucide="x" className="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Navbar */}
                    <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md bg-white/90 backdrop-blur-xl p-2 rounded-full shadow-[0_10px_30px_rgba(251,215,67,0.3)] flex justify-around items-center border border-white z-50">
                        {[
                            { id: 'home', icon: 'home', color: '#FBD743' },
                            { id: 'itinerary', icon: 'calendar', color: '#FFB7C5' },
                            { id: 'map', icon: 'map', color: '#A0D8EF' },
                            { id: 'budget', icon: 'wallet', color: '#C85994' }
                        ].map((item) => (
                            <button key={item.id} onClick={() => setActiveTab(item.id)} className={`p-4 rounded-full transition-all duration-300 relative ${activeTab === item.id ? '-translate-y-3 shadow-md bg-white' : ''}`}>
                                <i data-lucide={item.icon} className="w-6 h-6" style={{ color: activeTab === item.id ? item.color : '#DDD' }}></i>
                                {activeTab === item.id && <span className="absolute -bottom-2 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-[#5D4037]"></span>}
                            </button>
                        ))}
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
